I"ã <p><a href="https://www.tryhackme.com/room/blue"><strong>Solve Yourself¬†¬ª</strong></a></p>

<p>Blue is a machine that specifically designed to cover EternalBlue (CVE-2017-0144), 
which allows remote attackers to execute arbitrary code via crafted packets, 
aka ‚ÄúWindows SMB Remote Code Execution Vulnerability.‚Äù 
<br />
<br /></p>
<h2 id="1-enumeration">1-Enumeration</h2>

<p>Let us run Network Mapper (<strong>nmap</strong>) to discover opened ports and services.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Parameter</th>
      <th style="text-align: left">Functionality</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">-sV</td>
      <td style="text-align: left">Probe open ports to determine service/version info</td>
    </tr>
    <tr>
      <td style="text-align: left">-sC or ‚Äìscript=default</td>
      <td style="text-align: left">Performs a script scan using the default set of scripts</td>
    </tr>
    <tr>
      <td style="text-align: left">-O</td>
      <td style="text-align: left">Enable OS detection</td>
    </tr>
    <tr>
      <td style="text-align: left">-T4</td>
      <td style="text-align: left">T{0-5} Set scan speed, higher is faster</td>
    </tr>
    <tr>
      <td style="text-align: left">-p-</td>
      <td style="text-align: left">Scan all 65536 ports</td>
    </tr>
  </tbody>
</table>

<p>Full command :</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">nmap &lt;machine IP&gt; <span class="nt">-sV</span> <span class="nt">-sC</span> <span class="nt">-O</span> <span class="nt">-T4</span> <span class="nt">-p-</span></code></pre></figure>

<p><img src="/assets/img/posts/tryhackme-blue-ctf-writeup/blue2.jpg" alt="Desktop View" style="max-width: 80%" class="normal" /> 
<br />
It seems like plenty of services are enabled in the system.However one of them catches the eye.</p>

<p><em><strong>445 /tcp open microsoft-ds Windows 7 Professional 7601 Service Pack 1 microsoft-ds (workgroup : WORKGROUP)</strong></em></p>

<p>After went through the web searching phase for that specific service, we got this:</p>

<p><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-0144"><strong>CVE-2017-0144 - EternalBlue SMB Remote Code Execution (MS17-010)</strong></a>
<br /></p>

<h2 id="2-exploitation">2-Exploitation</h2>

<p>Let‚Äôs use <strong>Metasploit</strong> framework
<br />
<img src="/assets/img/posts/tryhackme-blue-ctf-writeup/blue3.jpg" alt="Desktop View" class="normal" />
<br />
And than use <strong>MS17-010</strong>
<img src="/assets/img/posts/tryhackme-blue-ctf-writeup/blue4.jpg" alt="Desktop View" class="normal" />
<br /></p>

<p>Six modules are showed up, two of them are auxiliary modules and the rest are exploiting scripts.In a real-life scenario it is not that obvious that those pre-arranged scripts would work.It is highly possible that target system would crash if you ran any careless exploit to target system or you are not sure host is vulnerable to it. To check this we can run <strong>auxiliary module</strong>.</p>

<p>If you are not familiar with what an auxiliary module is, it is some kind of script that helps us to verify if the target system is vulnerable to our actual exploit or not, without crashing or corrupting the system.
More technical description would be as following; An auxiliary module does not execute a payload. It can be used to perform arbitrary actions that may not be directly related to exploitation. Examples of auxiliary modules include scanners, fuzzers, and denial of service attacks.</p>

<p>In this case Metasploit database offers us those two auxiliary files, run:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">use auxiliary/scanner/smb/smb_ms17_010</code></pre></figure>

<p>Than set RHOSTS  as IP address of  our target machine, and run it.
<img src="/assets/img/posts/tryhackme-blue-ctf-writeup/blue5.jpg" alt="Desktop View" class="normal" />
<br />
As you can see, the output tells us the that, <strong>Host is likely VULNERABLE to MS17-010 !!!</strong> 
After that point we got our proof that the exploit would work.So let us move to the exploitation phase.</p>

<p><em>Exploit - An exploit module executes a sequence of commands to target a specific vulnerability found in a system or application. An exploit module takes advantage of a vulnerability to provide access to the target system. Exploit modules include buffer overflow, code injection, and web application exploit.</em></p>

<p>Run:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">use exploit/windows/smb/ms17_010_eternalblue</code></pre></figure>

<p>Like the previous auxiliary module, set RHOSTS as our target machine and run it.
<img src="/assets/img/posts/tryhackme-blue-ctf-writeup/blue6.jpg" alt="Desktop View" class="normal" />
<br />
<img src="/assets/img/posts/tryhackme-blue-ctf-writeup/blue7.jpg" alt="Desktop View" class="normal" />
<br />
Congrats !!! You‚Äôve hacked into the machine by using MS17-010 vulnerability.Now we have got our Meterpreter shell which provides additional powerful tools.</p>

<p>Now we need to use <strong>getsystem</strong> command,which is provided by Metasploit‚Äôs meterpreter shell, that will use number of different techniques in attempt to gain SYSTEM level priveleges on the remote target. 
<img src="/assets/img/posts/tryhackme-blue-ctf-writeup/blue8.jpg" alt="Desktop View" class="normal" />
<br />
Now, lets list all runnig processes with <strong>ps</strong> command, we will need to migrate our suspicious process into trusted process to ensure consistency.
<img src="/assets/img/posts/tryhackme-blue-ctf-writeup/blue9.jpg" alt="Desktop View" class="normal" />
<br />
SearchIndexer.exe seems like a good candidate to migrate our process.So type migrate {PID} to migrate spoolsv.exe, which is our reverse tcp payload.</p>

<p>Right now we have %100 access to target system and our session‚Äôs persistance is solid, lets move on for crediantels and flags.
<br /></p>

<h2 id="3-post-exploitation---capturing-the-flags">3-Post Exploitation - Capturing the Flags</h2>
<p>Just like the getsystem command, meterpreter provides <strong>hashdump</strong> command, which brings the system hashes for us.
<img src="/assets/img/posts/tryhackme-blue-ctf-writeup/blue10.jpg" alt="Desktop View" class="normal" />
<br />
We need to find out what kind of hashes they are. It is easy to tell they are NTLM hashes, because Windows is using NTLM hashes for system as default but for the best practice, lets use a hash analyzer to identify the type, you can use any hash analyzer.
<img src="/assets/img/posts/tryhackme-blue-ctf-writeup/blue11.jpg" alt="Desktop View" class="normal" />
<br />
As you can see, it is <strong>NTLM</strong>.</p>

<p>So, as we know the hash type, we can move forward for to cracking it.I will use <strong>John the Ripper</strong>,you can use <strong>Hashcat</strong> or any other cypher cracking tool.
<img src="/assets/img/posts/tryhackme-blue-ctf-writeup/blue12.jpg" alt="Desktop View" class="normal" />
<br /></p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Parameter</th>
      <th style="text-align: left">Functionality</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">hashes</td>
      <td style="text-align: left">ASCII Text file, which contains copied hashes.</td>
    </tr>
    <tr>
      <td style="text-align: left">‚Äìwordlist</td>
      <td style="text-align: left">Location of the wordlist</td>
    </tr>
    <tr>
      <td style="text-align: left">-format</td>
      <td style="text-align: left">Hash format</td>
    </tr>
  </tbody>
</table>

<p>We‚Äôve cracked the first hash.</p>

<p>Now type shell to use windows‚Äô shell instead of meterpreter shell and start looking for flags.</p>
<h4 id="flag1txt">flag1.txt</h4>
<p><img src="/assets/img/posts/tryhackme-blue-ctf-writeup/blue13.jpg" alt="Desktop View" class="normal" />
<br /></p>
<h4 id="flag2txt">flag2.txt</h4>
<p><img src="/assets/img/posts/tryhackme-blue-ctf-writeup/blue14.jpg" alt="Desktop View" class="normal" />
<br /></p>
<h4 id="flag3txt">flag3.txt</h4>
<p><img src="/assets/img/posts/tryhackme-blue-ctf-writeup/blue15.jpg" alt="Desktop View" class="normal" />
<br />
Congrats! End of the machine.</p>
:ET